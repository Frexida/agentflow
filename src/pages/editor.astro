---
import Base from '../layouts/Base.astro';
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<Base title="AgentFlow ã‚¨ãƒ‡ã‚£ã‚¿">
  <link rel="stylesheet" href={`${base}/drawflow.min.css`} />
  <style is:global>
    body { background: #0f0f0f; }

    #drawflow {
      width: 100vw;
      height: calc(100vh - 48px);
      background: #0f0f0f;
    }
    .toolbar {
      height: 48px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 12px;
      border-bottom: 1px solid #2a2a2a;
    }
    .toolbar .org-name {
      color: #9ca3af;
      font-size: 13px;
      margin-right: 8px;
      padding: 4px 8px;
      background: #1f1f1f;
      border-radius: 4px;
      border: 1px solid #333;
    }
    .toolbar button {
      padding: 6px 14px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 150ms;
    }
    .toolbar button:hover { background: #2563eb; }
    .toolbar button.secondary { background: #333; }
    .toolbar button.secondary:hover { background: #444; }
    .toolbar button.danger { background: #dc2626; }
    .toolbar button.danger:hover { background: #b91c1c; }
    .toolbar .spacer { flex: 1; }

    /* ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ */
    .agent-card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      min-width: 180px;
      color: #e2e8f0;
      font-family: -apple-system, sans-serif;
      transition: border-color 150ms;
    }
    .agent-card .agent-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .agent-card .agent-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .agent-card .agent-name {
      font-weight: bold;
      font-size: 14px;
    }
    .agent-card .agent-role {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .agent-card .agent-model {
      font-size: 10px;
      color: #555;
      background: #111;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
    }

    /* Drawflow overrides */
    .drawflow .drawflow-node {
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      min-width: auto !important;
    }
    .drawflow .drawflow-node.selected .agent-card {
      border-color: #3b82f6;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
    }
    .drawflow .connection .main-path {
      stroke: #ef4444 !important;
      stroke-width: 2.5 !important;
      marker-end: url(#arrow-authority) !important;
    }
    .drawflow .connection.link-communication .main-path {
      stroke: #3b82f6 !important;
      stroke-dasharray: 8 4 !important;
      marker-end: url(#arrow-communication) !important;
    }
    .drawflow .connection.link-review .main-path {
      stroke: #f59e0b !important;
      stroke-dasharray: 3 3 !important;
      marker-end: url(#arrow-review) !important;
    }
    .drawflow .drawflow-node .input, .drawflow .drawflow-node .output {
      background: #555 !important;
      border: 1px solid #777 !important;
    }
    /* Vertical ports: input on top, output on bottom */
    .drawflow .drawflow-node .inputs {
      position: absolute;
      top: -12px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .drawflow .drawflow-node .outputs {
      position: absolute;
      bottom: -12px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 8px;
    }
    .drawflow .drawflow-node .input, .drawflow .drawflow-node .output {
      position: relative !important;
      top: auto !important;
      right: auto !important;
      left: auto !important;
      bottom: auto !important;
    }

    /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
    #side-panel {
      position: fixed;
      top: 48px;
      right: 0;
      width: 360px;
      height: calc(100vh - 48px);
      background: #141414;
      border-left: 1px solid #2a2a2a;
      transform: translateX(100%);
      transition: transform 150ms ease;
      z-index: 200;
      overflow-y: auto;
      padding: 20px;
    }
    #side-panel.open { transform: translateX(0); }
    #side-panel h3 {
      font-size: 16px;
      margin-bottom: 16px;
      color: #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #side-panel .close-btn {
      background: none;
      border: none;
      color: #6b7280;
      font-size: 20px;
      cursor: pointer;
    }
    #side-panel .close-btn:hover { color: #fff; }
    .field { margin-bottom: 14px; }
    .field label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 8px 10px;
      background: #1f1f1f;
      border: 1px solid #333;
      border-radius: 6px;
      color: #e5e7eb;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color 150ms;
    }
    .field input:focus, .field select:focus, .field textarea:focus {
      border-color: #3b82f6;
    }
    .field textarea { min-height: 80px; resize: vertical; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #1a1a1a;
      border: 1px solid #333;
      color: #e5e7eb;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 13px;
      z-index: 300;
      opacity: 0;
      transition: opacity 150ms;
    }
    .toast.show { opacity: 1; }

    /* Onboarding hints */
    .hints-overlay {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(59, 130, 246, 0.4);
      color: #cbd5e1;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .hints-overlay .hint-item {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .hints-overlay .hint-key {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .hints-overlay .hint-close {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      font-size: 16px;
      padding: 0 4px;
      margin-left: 8px;
    }
    .hints-overlay .hint-close:hover { color: #e2e8f0; }
  </style>

  <div class="toolbar">
    <span class="org-name" id="org-name-display">ç„¡é¡Œã®çµ„ç¹”</span>
    <button id="btn-new-org" class="secondary">ğŸ¢ æ–°è¦çµ„ç¹”</button>
    <button id="btn-add-agent">+ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¿½åŠ </button>
    <button id="btn-auto-layout" class="secondary">â¬¡ è‡ªå‹•æ•´åˆ—</button>
    <button id="btn-groups" class="secondary">ğŸ“ ã‚°ãƒ«ãƒ¼ãƒ—</button>
    <button id="btn-templates" class="secondary">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
    <div class="spacer"></div>
    <button id="btn-import" class="secondary">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <input type="file" id="import-file" accept=".json" style="display:none" />
    <button id="btn-export" class="secondary">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button id="btn-save" class="secondary">ğŸ’¾ ä¿å­˜</button>
    <button id="btn-clear" class="danger">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
  </div>
  <svg style="position:absolute;width:0;height:0">
    <defs>
      <marker id="arrow-authority" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444" />
      </marker>
      <marker id="arrow-communication" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="#3b82f6" />
      </marker>
      <marker id="arrow-review" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto-start-reverse">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="#f59e0b" />
      </marker>
    </defs>
  </svg>
  <div id="drawflow"></div>

  <div id="side-panel">
    <h3>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç·¨é›† <button class="close-btn" id="panel-close">âœ•</button></h3>
    <div class="field"><label>ã‚¢ã‚¤ã‚³ãƒ³ (çµµæ–‡å­—)</label><input type="text" id="edit-icon" maxlength="4" /></div>
    <div class="field"><label>åå‰</label><input type="text" id="edit-name" /></div>
    <div class="field"><label>å½¹å‰²</label><input type="text" id="edit-role" /></div>
    <div class="field"><label>æ€§æ ¼</label><textarea id="edit-personality"></textarea></div>
    <div class="field"><label>ãƒ¢ãƒ‡ãƒ«</label>
      <select id="edit-model">
        <option value="anthropic/claude-opus-4-6">claude-opus-4-6</option>
        <option value="openai/gpt-5.3-codex">gpt-5.3-codex</option>
        <option value="anthropic/claude-sonnet-4">claude-sonnet-4</option>
        <option value="google/gemini-2.5-pro">gemini-2.5-pro</option>
      </select>
    </div>
    <div class="field"><label>ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</label><textarea id="edit-prompt" style="min-height:120px"></textarea></div>
    <div class="field"><label>ãƒ„ãƒ¼ãƒ«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</label>
      <select id="edit-tools">
        <option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
        <option value="minimal">minimal â€” åŸºæœ¬ãƒ„ãƒ¼ãƒ«ã®ã¿</option>
        <option value="coding">coding â€” ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‘ã‘</option>
        <option value="messaging">messaging â€” ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°å‘ã‘</option>
        <option value="full">full â€” å…¨ãƒ„ãƒ¼ãƒ«</option>
      </select>
    </div>
    <div class="field"><label>åˆæœŸè¨˜æ†¶ (MEMORY.md)</label><textarea id="edit-memory" style="min-height:80px" placeholder="ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åˆæœŸçŸ¥è­˜ã‚„è¨˜æ†¶..."></textarea></div>
    <hr style="border-color:#333;margin:16px 0" />
    <button id="btn-delete-agent" style="width:100%;padding:8px;background:#dc2626;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px">ğŸ—‘ ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å‰Šé™¤</button>
  </div>

  <div id="group-panel" style="position:fixed;top:48px;left:0;width:320px;height:calc(100vh - 48px);background:#141414;border-right:1px solid #2a2a2a;transform:translateX(-100%);transition:transform 150ms ease;z-index:200;overflow-y:auto;padding:20px">
    <h3 style="color:#e5e7eb;font-size:16px;margin:0 0 16px;display:flex;justify-content:space-between;align-items:center">
      ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç† <button id="group-panel-close" style="background:none;border:none;color:#6b7280;font-size:20px;cursor:pointer">âœ•</button>
    </h3>
    <button id="btn-add-group" style="width:100%;padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;margin-bottom:16px">+ ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ </button>
    <div id="group-list"></div>
  </div>

  <div id="link-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;z-index:400;min-width:300px">
    <h3 style="color:#e5e7eb;margin:0 0 16px;font-size:15px">ãƒªãƒ³ã‚¯ç·¨é›†</h3>
    <div class="field"><label>ã‚¿ã‚¤ãƒ—</label>
      <select id="link-type">
        <option value="authority">ğŸ”´ authorityï¼ˆæŒ‡æ®ï¼‰</option>
        <option value="communication">ğŸ”µ communicationï¼ˆé€šä¿¡ï¼‰</option>
        <option value="review">ğŸŸ¡ reviewï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</option>
      </select>
    </div>
    <div class="field"><label>ãƒ©ãƒ™ãƒ«ï¼ˆèª¬æ˜ï¼‰</label><input type="text" id="link-label" placeholder="ä¾‹: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼" /></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="link-modal-save" style="flex:1;padding:8px;background:#3b82f6;color:white;border:none;border-radius:6px;cursor:pointer">ä¿å­˜</button>
      <button id="link-modal-delete" style="padding:8px 12px;background:#dc2626;color:white;border:none;border-radius:6px;cursor:pointer">å‰Šé™¤</button>
      <button id="link-modal-close" style="padding:8px 12px;background:#333;color:white;border:none;border-radius:6px;cursor:pointer">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="link-modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:399"></div>

  <!-- Template modal -->
  <div id="template-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:499"></div>
  <div id="template-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:24px;z-index:500;width:520px;max-width:90vw;max-height:80vh;overflow-y:auto">
    <h3 style="color:#e5e7eb;margin:0 0 16px;display:flex;justify-content:space-between;align-items:center">
      ğŸ“‹ çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
      <button id="template-modal-close" style="background:none;border:none;color:#6b7280;font-size:20px;cursor:pointer">âœ•</button>
    </h3>
    <p style="color:#9ca3af;font-size:13px;margin:0 0 16px">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã™ã‚‹ã¨ã€ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒç½®æ›ã•ã‚Œã¾ã™ã€‚</p>
    <div style="display:flex;flex-direction:column;gap:12px">
      <button class="template-card" data-template="startup" style="text-align:left;padding:16px;background:#1f1f1f;border:1px solid #333;border-radius:8px;color:#e5e7eb;cursor:pointer;transition:border-color 150ms">
        <div style="font-size:15px;font-weight:bold;margin-bottom:4px">ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—å‹</div>
        <div style="font-size:12px;color:#9ca3af">CEO â†’ PM â†’ DevÃ—2 ã®ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ ã€‚å°‘äººæ•°ã§ç´ æ—©ãå‹•ããƒãƒ¼ãƒ å‘ã‘ã€‚</div>
        <div style="font-size:11px;color:#6b7280;margin-top:6px">4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ / authority + communication</div>
      </button>
      <button class="template-card" data-template="hierarchy" style="text-align:left;padding:16px;background:#1f1f1f;border:1px solid #333;border-radius:8px;color:#e5e7eb;cursor:pointer;transition:border-color 150ms">
        <div style="font-size:15px;font-weight:bold;margin-bottom:4px">ğŸ¢ éšå±¤å‹</div>
        <div style="font-size:12px;color:#9ca3af">Director â†’ ManagerÃ—2 â†’ MemberÃ—4 ã®ç¸¦å‹çµ„ç¹”ã€‚å¤§è¦æ¨¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‘ã‘ã€‚</div>
        <div style="font-size:11px;color:#6b7280;margin-top:6px">7ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ / authority + review</div>
      </button>
      <button class="template-card" data-template="flat" style="text-align:left;padding:16px;background:#1f1f1f;border:1px solid #333;border-radius:8px;color:#e5e7eb;cursor:pointer;transition:border-color 150ms">
        <div style="font-size:15px;font-weight:bold;margin-bottom:4px">ğŸ¤ ãƒ•ãƒ©ãƒƒãƒˆå‹</div>
        <div style="font-size:12px;color:#9ca3af">Lead + MemberÃ—3 ã®æ¨ªä¸¦ã³æ§‹é€ ã€‚å…¨å“¡ãŒå¯¾ç­‰ã«å”åŠ›ã™ã‚‹ãƒãƒ¼ãƒ å‘ã‘ã€‚</div>
        <div style="font-size:11px;color:#6b7280;margin-top:6px">4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ / communication</div>
      </button>
    </div>
  </div>

  <div class="hints-overlay" id="hints-overlay" style="display:none;">
    <span class="hint-item"><span class="hint-key">ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯</span> ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç·¨é›†</span>
    <span class="hint-item"><span class="hint-key">ãƒ‰ãƒ©ãƒƒã‚°</span> ãƒãƒ¼ãƒ‰é–“æ¥ç¶š</span>
    <span class="hint-item"><span class="hint-key">ã‚¯ãƒªãƒƒã‚¯</span> ãƒªãƒ³ã‚¯ã‚¿ã‚¤ãƒ—åˆ‡æ›¿</span>
    <span class="hint-item" style="margin-left:12px;border-left:1px solid #444;padding-left:12px">
      <span style="color:#ef4444">â”â”â–¶</span> æŒ‡æ®
      <span style="color:#3b82f6;margin-left:8px">â•Œâ•Œâ–¶</span> é€šä¿¡
      <span style="color:#f59e0b;margin-left:8px">Â·Â·Â·â–¶</span> ãƒ¬ãƒ“ãƒ¥ãƒ¼
    </span>
    <button class="hint-close" id="hints-close" title="é–‰ã˜ã‚‹">âœ•</button>
  </div>
  <div class="toast" id="toast"></div>

  <script src={`${base}/drawflow.min.js`} is:inline></script>
  <script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js" is:inline></script>
  <script is:inline>
  (function() {
    'use strict';

    const STORAGE_KEY = 'agentflow_org';
    const MODELS = [
      'anthropic/claude-opus-4-6',
      'openai/gpt-5.3-codex',
      'anthropic/claude-sonnet-4',
      'google/gemini-2.5-pro'
    ];
    const LINK_TYPES = ['authority', 'communication', 'review'];
    const LINK_COLORS = { authority: '#ef4444', communication: '#3b82f6', review: '#f59e0b' };
    const DEFAULT_ICONS = ['ğŸ‘”', 'âš™ï¸', 'ğŸ”¬', 'ğŸ¨', 'ğŸ‘ï¸', 'ğŸ§ª', 'ğŸ“Š', 'ğŸ›¡ï¸'];

    // --- Organization State ---
    let org = {
      id: crypto.randomUUID(),
      name: 'ç„¡é¡Œã®çµ„ç¹”',
      description: '',
      version: 'v1',
      agents: [],
      links: [],
      groups: []
    };

    // nodeId (drawflow int) -> agentId mapping
    let nodeToAgent = {};
    // connectionId -> linkType
    let connectionTypes = {};

    // --- Drawflow init ---
    const container = document.getElementById('drawflow');
    const editor = new Drawflow(container);
    editor.reroute = true;
    editor.curvature = 0.5;
    editor.reroute_curvature_start_end = 0.5;
    editor.reroute_curvature = 0.5;
    editor.start();

    // --- Helpers ---
    function uid() { return 'a' + crypto.randomUUID().slice(0, 8); }

    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }

    function agentById(id) { return org.agents.find(a => a.id === id); }
    function nodeIdForAgent(agentId) {
      return Object.keys(nodeToAgent).find(k => nodeToAgent[k] === agentId);
    }

    function createAgentHTML(agent) {
      return `<div class="agent-card" data-agent-id="${agent.id}">
        <div class="agent-header">
          <div class="agent-icon">${agent.icon || 'ğŸ¤–'}</div>
          <div class="agent-name">${agent.name}</div>
        </div>
        <div class="agent-role">${agent.role || 'æœªè¨­å®š'}</div>
        <div class="agent-model">${(agent.model || MODELS[0]).split('/').pop()}</div>
      </div>`;
    }

    function updateNodeHTML(agentId) {
      const agent = agentById(agentId);
      const nid = nodeIdForAgent(agentId);
      if (!agent || !nid) return;
      const nodeEl = container.querySelector(`#node-${nid}`);
      if (!nodeEl) return;
      const content = nodeEl.querySelector('.drawflow_content_node');
      if (content) content.innerHTML = createAgentHTML(agent);
    }

    // --- Group Overlays ---
    const GROUP_COLORS = [
      { bg: 'rgba(59,130,246,0.08)', border: 'rgba(59,130,246,0.35)', text: '#60a5fa' },
      { bg: 'rgba(16,185,129,0.08)', border: 'rgba(16,185,129,0.35)', text: '#34d399' },
      { bg: 'rgba(245,158,11,0.08)', border: 'rgba(245,158,11,0.35)', text: '#fbbf24' },
      { bg: 'rgba(168,85,247,0.08)', border: 'rgba(168,85,247,0.35)', text: '#c084fc' },
      { bg: 'rgba(239,68,68,0.08)', border: 'rgba(239,68,68,0.35)', text: '#f87171' },
    ];

    function renderGroupOverlays() {
      // Remove existing overlays
      container.querySelectorAll('.group-overlay').forEach(el => el.remove());

      const drawflowData = editor.export()?.drawflow?.Home?.data;
      if (!drawflowData) return;

      org.groups.forEach((group, gi) => {
        if (!group.agentIds || group.agentIds.length === 0) return;

        const color = GROUP_COLORS[gi % GROUP_COLORS.length];
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        let found = 0;

        for (const agentId of group.agentIds) {
          const nodeId = nodeIdForAgent(agentId);
          if (!nodeId || !drawflowData[nodeId]) continue;
          const node = drawflowData[nodeId];
          const el = container.querySelector(`#node-${nodeId}`);
          const w = el ? el.offsetWidth : 200;
          const h = el ? el.offsetHeight : 100;
          minX = Math.min(minX, node.pos_x);
          minY = Math.min(minY, node.pos_y);
          maxX = Math.max(maxX, node.pos_x + w);
          maxY = Math.max(maxY, node.pos_y + h);
          found++;
        }

        if (found === 0) return;

        const pad = 24;
        const overlay = document.createElement('div');
        overlay.className = 'group-overlay';
        overlay.style.cssText = `
          position: absolute;
          left: ${minX - pad}px;
          top: ${minY - pad}px;
          width: ${maxX - minX + pad * 2}px;
          height: ${maxY - minY + pad * 2}px;
          background: ${color.bg};
          border: 1.5px dashed ${color.border};
          border-radius: 12px;
          pointer-events: none;
          z-index: 0;
        `;

        const label = document.createElement('div');
        label.style.cssText = `
          position: absolute;
          top: -10px;
          left: 12px;
          background: #0f0f0f;
          color: ${color.text};
          font-size: 11px;
          font-weight: bold;
          padding: 2px 8px;
          border-radius: 4px;
          border: 1px solid ${color.border};
        `;
        label.textContent = group.name;
        overlay.appendChild(label);

        // Insert into drawflow's inner container
        const inner = container.querySelector('.drawflow') || container;
        inner.appendChild(overlay);
      });
    }

    // Update overlays on various events
    let overlayTimer;
    function scheduleOverlayUpdate() {
      clearTimeout(overlayTimer);
      overlayTimer = setTimeout(renderGroupOverlays, 50);
    }

    // --- Add Agent ---
    function addAgent(agentData, x, y) {
      const agent = {
        id: agentData?.id || uid(),
        name: agentData?.name || `Agent ${org.agents.length + 1}`,
        role: agentData?.role || '',
        personality: agentData?.personality || '',
        icon: agentData?.icon || DEFAULT_ICONS[org.agents.length % DEFAULT_ICONS.length],
        model: agentData?.model || MODELS[0],
        systemPrompt: agentData?.systemPrompt || '',
        toolsProfile: agentData?.toolsProfile || '',
        memory: agentData?.memory || '',
      };
      org.agents.push(agent);

      const px = x ?? 100 + (org.agents.length % 4) * 260;
      const py = y ?? 80 + Math.floor(org.agents.length / 4) * 200;
      const nodeId = editor.addNode(
        agent.id, 1, 1, px, py, 'agent-node', { agentId: agent.id }, createAgentHTML(agent)
      );
      nodeToAgent[nodeId] = agent.id;
      scheduleSave();
      return agent;
    }

    document.getElementById('btn-add-agent').addEventListener('click', () => {
      addAgent();
    });

    // --- Double-click â†’ side panel ---
    let editingAgentId = null;
    const panel = document.getElementById('side-panel');

    editor.on('nodeSelected', function(nodeId) {
      // single click - no action
    });

    container.addEventListener('dblclick', (e) => {
      const card = e.target.closest('.agent-card');
      if (!card) return;
      const agentId = card.dataset.agentId;
      openPanel(agentId);
    });

    function openPanel(agentId) {
      const agent = agentById(agentId);
      if (!agent) return;
      editingAgentId = agentId;
      document.getElementById('edit-icon').value = agent.icon || '';
      document.getElementById('edit-name').value = agent.name || '';
      document.getElementById('edit-role').value = agent.role || '';
      document.getElementById('edit-personality').value = agent.personality || '';
      document.getElementById('edit-model').value = agent.model || MODELS[0];
      document.getElementById('edit-prompt').value = agent.systemPrompt || '';
      document.getElementById('edit-tools').value = agent.toolsProfile || '';
      document.getElementById('edit-memory').value = agent.memory || '';
      panel.classList.add('open');
    }

    function closePanel() {
      panel.classList.remove('open');
      editingAgentId = null;
    }

    document.getElementById('panel-close').addEventListener('click', closePanel);

    // Live editing
    ['edit-icon', 'edit-name', 'edit-role', 'edit-personality', 'edit-model', 'edit-prompt', 'edit-tools', 'edit-memory'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        if (!editingAgentId) return;
        const agent = agentById(editingAgentId);
        if (!agent) return;
        agent.icon = document.getElementById('edit-icon').value;
        agent.name = document.getElementById('edit-name').value;
        agent.role = document.getElementById('edit-role').value;
        agent.personality = document.getElementById('edit-personality').value;
        agent.model = document.getElementById('edit-model').value;
        agent.systemPrompt = document.getElementById('edit-prompt').value;
        agent.toolsProfile = document.getElementById('edit-tools').value;
        agent.memory = document.getElementById('edit-memory').value;
        updateNodeHTML(editingAgentId);
        scheduleSave();
      });
    });

    // --- Delete agent from panel ---
    document.getElementById('btn-delete-agent').addEventListener('click', () => {
      if (!editingAgentId) return;
      const agent = agentById(editingAgentId);
      if (!confirm(`ã€Œ${agent?.name || editingAgentId}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      const nid = nodeIdForAgent(editingAgentId);
      if (nid) editor.removeNodeId('node-' + nid);
      closePanel();
    });

    // --- Connection / Link management ---
    editor.on('connectionCreated', function(info) {
      const srcAgentId = nodeToAgent[info.output_id];
      const tgtAgentId = nodeToAgent[info.input_id];
      if (!srcAgentId || !tgtAgentId) return;

      const linkId = uid();
      org.links.push({
        id: linkId,
        source: srcAgentId,
        target: tgtAgentId,
        type: 'authority',
      });

      // Store connection key -> link mapping
      const connKey = `${info.output_id}_${info.input_id}`;
      connectionTypes[connKey] = { linkId, type: 'authority' };
      applyConnectionColor(info.output_id, info.input_id, 'authority');
      scheduleSave();
    });

    editor.on('connectionRemoved', function(info) {
      const connKey = `${info.output_id}_${info.input_id}`;
      const ct = connectionTypes[connKey];
      if (ct) {
        org.links = org.links.filter(l => l.id !== ct.linkId);
        delete connectionTypes[connKey];
      }
      scheduleSave();
    });

    editor.on('nodeRemoved', function(nodeId) {
      const agentId = nodeToAgent[nodeId];
      if (agentId) {
        org.agents = org.agents.filter(a => a.id !== agentId);
        org.links = org.links.filter(l => l.source !== agentId && l.target !== agentId);
        delete nodeToAgent[nodeId];
        if (editingAgentId === agentId) closePanel();
      }
      // Clean connectionTypes
      for (const key of Object.keys(connectionTypes)) {
        if (key.startsWith(nodeId + '_') || key.endsWith('_' + nodeId)) {
          delete connectionTypes[key];
        }
      }
      scheduleSave();
      scheduleOverlayUpdate();
    });

    // Track mouse-up on drawflow to catch node drags
    container.addEventListener('mouseup', scheduleOverlayUpdate);

    function applyConnectionColor(outId, inId, type) {
      // Find the SVG connection element
      setTimeout(() => {
        const connections = container.querySelectorAll('.connection');
        connections.forEach(conn => {
          const classes = conn.classList;
          const path = conn.querySelector('.main-path');
          if (!path) return;
          // Match by node ids in class
          if (classes.contains(`node_out_node-${outId}`) && classes.contains(`node_in_node-${inId}`)) {
            conn.classList.remove('link-authority', 'link-communication', 'link-review');
            conn.classList.add('link-' + type);
            path.style.stroke = LINK_COLORS[type];
          }
        });
      }, 50);
    }

    function applyAllConnectionColors() {
      for (const [key, ct] of Object.entries(connectionTypes)) {
        const [outId, inId] = key.split('_');
        applyConnectionColor(outId, inId, ct.type);
      }
    }

    // Click on connection to cycle link type
    container.addEventListener('click', (e) => {
      const path = e.target.closest('.main-path');
      if (!path) return;
      const conn = path.closest('.connection');
      if (!conn) return;

      // Find which connection this is
      for (const [key, ct] of Object.entries(connectionTypes)) {
        const [outId, inId] = key.split('_');
        if (conn.classList.contains(`node_out_node-${outId}`) && conn.classList.contains(`node_in_node-${inId}`)) {
          const idx = LINK_TYPES.indexOf(ct.type);
          const newType = LINK_TYPES[(idx + 1) % LINK_TYPES.length];
          ct.type = newType;
          const link = org.links.find(l => l.id === ct.linkId);
          if (link) link.type = newType;
          applyConnectionColor(outId, inId, newType);
          toast(`ãƒªãƒ³ã‚¯ã‚¿ã‚¤ãƒ—: ${newType}`);
          scheduleSave();
          break;
        }
      }
    });

    // --- Link modal (double-click to edit) ---
    let editingConnKey = null;
    const linkModal = document.getElementById('link-modal');
    const linkOverlay = document.getElementById('link-modal-overlay');

    function openLinkModal(connKey) {
      const ct = connectionTypes[connKey];
      if (!ct) return;
      const link = org.links.find(l => l.id === ct.linkId);
      if (!link) return;
      editingConnKey = connKey;
      document.getElementById('link-type').value = link.type;
      document.getElementById('link-label').value = link.label || '';
      linkModal.style.display = 'block';
      linkOverlay.style.display = 'block';
    }

    function closeLinkModal() {
      linkModal.style.display = 'none';
      linkOverlay.style.display = 'none';
      editingConnKey = null;
    }

    document.getElementById('link-modal-close').addEventListener('click', closeLinkModal);
    linkOverlay.addEventListener('click', closeLinkModal);

    document.getElementById('link-modal-save').addEventListener('click', () => {
      if (!editingConnKey) return;
      const ct = connectionTypes[editingConnKey];
      if (!ct) return;
      const link = org.links.find(l => l.id === ct.linkId);
      if (!link) return;
      const newType = document.getElementById('link-type').value;
      const newLabel = document.getElementById('link-label').value;
      link.type = newType;
      link.label = newLabel || undefined;
      ct.type = newType;
      const [outId, inId] = editingConnKey.split('_');
      applyConnectionColor(outId, inId, newType);
      toast(`ãƒªãƒ³ã‚¯æ›´æ–°: ${newType}${newLabel ? ' â€” ' + newLabel : ''}`);
      scheduleSave();
      closeLinkModal();
    });

    document.getElementById('link-modal-delete').addEventListener('click', () => {
      if (!editingConnKey) return;
      const [outId, inId] = editingConnKey.split('_');
      // Remove from drawflow
      const data = editor.export().drawflow.Home.data;
      const outNode = data[outId];
      if (outNode) {
        for (const [oKey, output] of Object.entries(outNode.outputs)) {
          output.connections = output.connections.filter(c => String(c.node) !== String(inId));
        }
      }
      const inNode = data[inId];
      if (inNode) {
        for (const [iKey, input] of Object.entries(inNode.inputs)) {
          input.connections = input.connections.filter(c => String(c.node) !== String(outId));
        }
      }
      editor.import({ drawflow: { Home: { data } } });
      // Clean up org state
      const ct = connectionTypes[editingConnKey];
      if (ct) org.links = org.links.filter(l => l.id !== ct.linkId);
      delete connectionTypes[editingConnKey];
      setTimeout(applyAllConnectionColors, 100);
      toast('ãƒªãƒ³ã‚¯å‰Šé™¤');
      scheduleSave();
      closeLinkModal();
    });

    container.addEventListener('dblclick', (e) => {
      const path = e.target.closest('.main-path');
      if (!path) return;
      const conn = path.closest('.connection');
      if (!conn) return;
      for (const [key, ct] of Object.entries(connectionTypes)) {
        const [outId, inId] = key.split('_');
        if (conn.classList.contains(`node_out_node-${outId}`) && conn.classList.contains(`node_in_node-${inId}`)) {
          openLinkModal(key);
          break;
        }
      }
    });

    // --- Group management ---
    const groupPanel = document.getElementById('group-panel');
    const groupList = document.getElementById('group-list');

    document.getElementById('btn-groups').addEventListener('click', () => {
      groupPanel.style.transform = groupPanel.style.transform === 'translateX(0px)' ? 'translateX(-100%)' : 'translateX(0px)';
      renderGroupList();
    });
    document.getElementById('group-panel-close').addEventListener('click', () => {
      groupPanel.style.transform = 'translateX(-100%)';
    });

    document.getElementById('btn-add-group').addEventListener('click', () => {
      const name = prompt('ã‚°ãƒ«ãƒ¼ãƒ—å:');
      if (!name) return;
      org.groups.push({ id: uid(), name, description: '', agentIds: [] });
      renderGroupList();
      scheduleSave();
    });

    function renderGroupList() {
      scheduleOverlayUpdate();
      groupList.innerHTML = '';
      for (const group of org.groups) {
        const div = document.createElement('div');
        div.style.cssText = 'background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:12px;margin-bottom:10px';
        const members = group.agentIds.map(id => agentById(id)?.name || id).join(', ') || 'ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ãªã—ï¼‰';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong style="color:#e5e7eb;font-size:14px">${group.name}</strong>
            <button data-delete-group="${group.id}" style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:16px">âœ•</button>
          </div>
          <div style="font-size:12px;color:#6b7280;margin-bottom:8px">${members}</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px">
            ${org.agents.map(a => {
              const inGroup = group.agentIds.includes(a.id);
              return `<button data-toggle-member="${group.id}:${a.id}" style="padding:3px 8px;font-size:11px;border-radius:4px;border:1px solid ${inGroup ? '#3b82f6' : '#333'};background:${inGroup ? '#1e3a5f' : '#1f1f1f'};color:${inGroup ? '#93c5fd' : '#6b7280'};cursor:pointer">${a.icon || 'ğŸ¤–'} ${a.name}</button>`;
            }).join('')}
          </div>
        `;
        groupList.appendChild(div);
      }
      // Event delegation
      groupList.querySelectorAll('[data-toggle-member]').forEach(btn => {
        btn.addEventListener('click', () => {
          const [gid, aid] = btn.dataset.toggleMember.split(':');
          const group = org.groups.find(g => g.id === gid);
          if (!group) return;
          const idx = group.agentIds.indexOf(aid);
          if (idx >= 0) group.agentIds.splice(idx, 1);
          else group.agentIds.push(aid);
          renderGroupList();
          scheduleSave();
        });
      });
      groupList.querySelectorAll('[data-delete-group]').forEach(btn => {
        btn.addEventListener('click', () => {
          const gid = btn.dataset.deleteGroup;
          org.groups = org.groups.filter(g => g.id !== gid);
          renderGroupList();
          scheduleSave();
        });
      });
    }

    // --- Auto Layout (dagre) ---
    document.getElementById('btn-auto-layout').addEventListener('click', () => {
      const data = editor.export().drawflow.Home.data;
      const nodeIds = Object.keys(data);
      if (nodeIds.length === 0) return;

      const g = new dagre.graphlib.Graph();
      g.setGraph({ rankdir: 'TB', nodesep: 80, ranksep: 140 });
      g.setDefaultEdgeLabel(() => ({}));

      nodeIds.forEach(id => g.setNode(id, { width: 200, height: 100 }));
      nodeIds.forEach(id => {
        const node = data[id];
        Object.values(node.outputs || {}).forEach(output => {
          (output.connections || []).forEach(conn => g.setEdge(id, conn.node));
        });
      });

      dagre.layout(g);
      nodeIds.forEach(id => {
        const pos = g.node(id);
        data[id].pos_x = pos.x - 100;
        data[id].pos_y = pos.y - 50;
      });

      editor.import({ drawflow: { Home: { data } } });
      // Re-apply colors after import
      setTimeout(() => { applyAllConnectionColors(); renderGroupOverlays(); }, 100);
    });

    // --- Export ---
    function validateOrg(org) {
      const warnings = [];
      const errors = [];
      if (org.agents.length === 0) errors.push('ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒ1ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“');
      const names = org.agents.map(a => a.name);
      const dupes = names.filter((n, i) => names.indexOf(n) !== i);
      if (dupes.length) errors.push(`é‡è¤‡å: ${[...new Set(dupes)].join(', ')}`);
      for (const a of org.agents) {
        if (!a.name || a.name.trim() === '') errors.push(`åå‰æœªè¨­å®šã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™ (${a.id})`);
        if (!a.role || a.role.trim() === '') warnings.push(`${a.name}: å½¹å‰²ãŒæœªè¨­å®š`);
        if (!a.systemPrompt || a.systemPrompt.trim() === '') warnings.push(`${a.name}: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒç©º`);
      }
      // Check for orphan agents (no connections)
      const connectedIds = new Set(org.links.flatMap(l => [l.source, l.target]));
      const orphans = org.agents.filter(a => !connectedIds.has(a.id));
      if (orphans.length > 0 && org.agents.length > 1) {
        warnings.push(`æ¥ç¶šãªã—: ${orphans.map(a => a.name).join(', ')}`);
      }
      return { errors, warnings };
    }

    document.getElementById('btn-export').addEventListener('click', () => {
      const { errors, warnings } = validateOrg(org);
      if (errors.length > 0) {
        alert('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'));
        return;
      }
      if (warnings.length > 0) {
        if (!confirm('âš ï¸ è­¦å‘Š:\n' + warnings.join('\n') + '\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
      }
      const result = exportToOpenClaw(org);
      // Download config JSON (schema-compliant, for config.apply)
      const configBlob = new Blob([JSON.stringify(result.config, null, 2)], { type: 'application/json' });
      downloadBlob(configBlob, `${org.name || 'agentflow'}-openclaw.json`);
      // Download full export (config + meta + workspace files)
      const fullBlob = new Blob([JSON.stringify(result, null, 2)], { type: 'application/json' });
      downloadBlob(fullBlob, `${org.name || 'agentflow'}-full-export.json`);
      // Download workspace setup script
      const script = generateSetupScript(org, result);
      const scriptBlob = new Blob([script], { type: 'text/x-shellscript' });
      downloadBlob(scriptBlob, `${org.name || 'agentflow'}-setup.sh`);
      toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆ3ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰');
    });

    function generateSetupScript(org, result) {
      function slugify(s) {
        return s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'unnamed';
      }
      const lines = [
        '#!/usr/bin/env bash',
        `# AgentFlow workspace setup â€” ${org.name}`,
        `# Generated: ${new Date().toISOString()}`,
        'set -euo pipefail',
        '',
        'BASE_DIR="${1:-$HOME/.openclaw/workspace}"',
        'echo "Setting up agent workspaces in $BASE_DIR"',
        '',
      ];
      for (const agent of org.agents) {
        const slug = slugify(agent.name || agent.id);
        const files = result.meta.workspaceFiles[agent.id];
        if (!files) continue;
        lines.push(`# --- ${agent.name || agent.id} ---`);
        lines.push(`mkdir -p "$BASE_DIR/${slug}"`);
        for (const [fname, content] of Object.entries(files)) {
          lines.push(`cat > "$BASE_DIR/${slug}/${fname}" << 'AGENTFLOW_EOF'`);
          lines.push(content.trimEnd());
          lines.push('AGENTFLOW_EOF');
        }
        lines.push(`echo "  âœ“ ${agent.name || agent.id}"`);
        lines.push('');
      }
      lines.push('echo "Done. Run: openclaw gateway config.apply"');
      return lines.join('\n') + '\n';
    }

    function downloadBlob(blob, filename) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Inline export function v2 â€” OpenClaw config schema compliant
    function exportToOpenClaw(org) {
      function slugify(s) {
        return s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'unnamed';
      }
      function findAgent(id) { return org.agents.find(a => a.id === id); }
      function agentName(id) { return findAgent(id)?.name || id; }

      const GUILD_PH = 'REPLACE_WITH_GUILD_ID';
      const chPH = (id) => 'REPLACE_WITH_CHANNEL_ID_FOR_' + slugify(id).toUpperCase();
      const primaryModel = (org.agents[0]?.model) || 'anthropic/claude-opus-4-6';
      const baseWorkspace = '/home/user/.openclaw/workspace';

      // agents.list
      const list = org.agents.map(agent => {
        const agentSlug = slugify(agent.name || agent.id);
        const authTargets = org.links
          .filter(l => l.source === agent.id && l.type === 'authority')
          .map(l => l.target);
        const entry = {
          id: agent.id,
          name: agent.name,
          workspace: baseWorkspace + '/' + agentSlug,
          identity: { name: agent.name },
        };
        if (agent.model && agent.model !== primaryModel) entry.model = agent.model;
        if (agent.icon) entry.identity.avatar = agent.icon;
        if (authTargets.length > 0) entry.subagents = { allowAgents: authTargets };
        if (agent.toolsProfile) entry.tools = { profile: agent.toolsProfile };
        return entry;
      });

      // bindings
      const bindings = org.agents.map(agent => ({
        agentId: agent.id,
        match: { channel: 'discord', guildId: GUILD_PH, peer: { kind: 'channel', id: chPH(agent.id) } },
      }));

      // channels
      const channelConfigs = {};
      for (const agent of org.agents) {
        channelConfigs[chPH(agent.id)] = { allow: true, requireMention: false };
      }

      const config = {
        agents: {
          defaults: { model: { primary: primaryModel }, workspace: baseWorkspace },
          list,
        },
        bindings,
        channels: {
          discord: {
            enabled: true,
            groupPolicy: 'allowlist',
            guilds: { [GUILD_PH]: { requireMention: true, users: ['*'], channels: channelConfigs } },
          },
        },
        commands: { native: 'auto', nativeSkills: 'auto' },
      };

      // workspace files (SOUL.md + AGENTS.md per agent)
      const workspaceFiles = {};
      for (const agent of org.agents) {
        const files = {};
        // SOUL.md
        const soulParts = ['# ' + (agent.name || agent.id)];
        if (agent.personality) soulParts.push('## Personality\n' + agent.personality);
        if (agent.role) soulParts.push('## Role\n' + agent.role);
        if (agent.systemPrompt) soulParts.push('## Instructions\n' + agent.systemPrompt);
        // Org relationships in SOUL.md
        const rels = [];
        const superiors = org.links.filter(l => l.target === agent.id && l.type === 'authority').map(l => agentName(l.source));
        if (superiors.length) rels.push('- **Reports to:** ' + superiors.join(', ') + ' â€” prioritize their instructions');
        const subs = org.links.filter(l => l.source === agent.id && l.type === 'authority').map(l => agentName(l.target));
        if (subs.length) rels.push('- **Manages:** ' + subs.join(', ') + ' â€” can delegate tasks via sessions_spawn');
        const comms = org.links.filter(l => (l.source === agent.id || l.target === agent.id) && l.type === 'communication')
          .map(l => agentName(l.source === agent.id ? l.target : l.source));
        if (comms.length) rels.push('- **Communicates with:** ' + comms.join(', '));
        const reviewTargets = org.links.filter(l => l.source === agent.id && l.type === 'review').map(l => agentName(l.target));
        if (reviewTargets.length) rels.push('- **Reviews work of:** ' + reviewTargets.join(', '));
        const reviewedBy = org.links.filter(l => l.target === agent.id && l.type === 'review').map(l => agentName(l.source));
        if (reviewedBy.length) rels.push('- **Reviewed by:** ' + reviewedBy.join(', '));
        if (rels.length) soulParts.push('## Organization\n' + rels.join('\n'));
        files['SOUL.md'] = soulParts.join('\n\n') + '\n';

        // AGENTS.md
        const agLines = ['# AGENTS.md â€” Organization Context for ' + (agent.name || agent.id), ''];
        agLines.push('## Organization: ' + org.name);
        if (org.description) agLines.push('\n' + org.description);
        agLines.push('', '## Team Members');
        for (const a of org.agents) {
          const marker = a.id === agent.id ? ' **(you)**' : '';
          agLines.push('- **' + (a.name || a.id) + '**' + marker + ': ' + (a.role || 'No role defined'));
        }
        agLines.push('', '## Relationships');
        const authLinks = org.links.filter(l => l.type === 'authority');
        const commLinks2 = org.links.filter(l => l.type === 'communication');
        const revLinks2 = org.links.filter(l => l.type === 'review');
        if (authLinks.length) {
          agLines.push('### Authority (command chain)');
          for (const l of authLinks) agLines.push('- ' + agentName(l.source) + ' â†’ ' + agentName(l.target));
        }
        if (commLinks2.length) {
          agLines.push('### Communication');
          for (const l of commLinks2) agLines.push('- ' + agentName(l.source) + ' â†” ' + agentName(l.target));
        }
        if (revLinks2.length) {
          agLines.push('### Review');
          for (const l of revLinks2) agLines.push('- ' + agentName(l.source) + ' reviews ' + agentName(l.target));
        }
        if (!authLinks.length && !commLinks2.length && !revLinks2.length) {
          agLines.push('- Flat structure (no links defined)');
        }
        if (org.groups.length) {
          agLines.push('', '## Groups');
          for (const g of org.groups) {
            agLines.push('- **' + g.name + '**: ' + g.agentIds.map(id => agentName(id)).join(', '));
          }
        }
        files['AGENTS.md'] = agLines.join('\n') + '\n';

        if (agent.memory) files['MEMORY.md'] = '# Initial Memory\n\n' + agent.memory + '\n';
        workspaceFiles[agent.id] = files;
      }

      return {
        config,
        meta: {
          exportedFrom: 'agentflow',
          version: 'v2',
          organizationId: org.id,
          organizationName: org.name,
          exportedAt: new Date().toISOString(),
          workspaceFiles,
          links: org.links.map(l => ({ source: l.source, target: l.target, type: l.type, ...(l.label && { label: l.label }) })),
        },
      };
    }

    // --- Save / Load ---
    let saveTimer = null;
    function scheduleSave() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveToStorage, 5000);
    }

    function saveToStorage() {
      const drawflowData = editor.export();
      const state = { org, nodeToAgent, connectionTypes, drawflow: drawflowData };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      updateOrgDisplay();
      toast('ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const state = JSON.parse(raw);
        org = state.org;
        nodeToAgent = state.nodeToAgent || {};
        connectionTypes = state.connectionTypes || {};
        if (state.drawflow) {
          editor.import(state.drawflow);
          setTimeout(() => { applyAllConnectionColors(); renderGroupOverlays(); }, 100);
        }
        updateOrgDisplay();
        return true;
      } catch (e) {
        console.error('Failed to load:', e);
        return false;
      }
    }

    function updateOrgDisplay() {
      document.getElementById('org-name-display').textContent = org.name;
    }

    // --- Config Import ---
    document.getElementById('btn-import').addEventListener('click', () => {
      document.getElementById('import-file').click();
    });

    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const json = JSON.parse(ev.target.result);
          importConfig(json);
        } catch (err) {
          toast('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = ''; // reset for re-import
    });

    function importConfig(config) {
      // Support both OpenClaw config and AgentFlow full export
      const agents = config.agents?.list || config.org?.agents || [];
      const isOpenClawConfig = !!config.agents?.list;
      const isAgentFlowExport = !!config.org;

      if (agents.length === 0) {
        toast('ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      if (org.agents.length > 0 && !confirm('ç¾åœ¨ã®çµ„ç¹”ã‚’ç½®æ›ã—ã¾ã™ã‹ï¼Ÿã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) return;

      // Clear current
      editor.clear();
      org.agents = [];
      org.links = [];
      org.groups = [];
      nodeToAgent = {};
      connectionTypes = {};
      closePanel();

      if (isAgentFlowExport && config.org) {
        // AgentFlow full export â€” restore directly
        org.name = config.org.name || 'Imported Org';
        org.description = config.org.description || '';
        for (const a of config.org.agents || []) {
          addAgent(a, null, null);
        }
        // Restore links
        for (const link of config.org.links || []) {
          const srcAgent = agentById(link.source);
          const tgtAgent = agentById(link.target);
          if (srcAgent && tgtAgent) {
            connectAgents(srcAgent, tgtAgent, link.type || 'authority');
          }
        }
        // Restore groups
        org.groups = config.org.groups || [];

      } else if (isOpenClawConfig) {
        // OpenClaw config format
        org.name = 'OpenClaw Import';
        const bindings = config.bindings || [];
        const defaults = config.agents?.defaults || {};

        for (const agentDef of agents) {
          const model = agentDef.model || defaults.model?.primary || '';
          const binding = bindings.find(b => b.agentId === agentDef.id);
          const channelInfo = binding ? `${binding.match?.channel || ''} ${binding.match?.peer?.id || ''}`.trim() : '';

          addAgent({
            id: agentDef.id,
            name: agentDef.identity?.name || agentDef.name || agentDef.id,
            role: agentDef.id,
            icon: agentDef.identity?.avatar || 'ğŸ¤–',
            model: model,
            personality: '',
            systemPrompt: channelInfo ? `Channel binding: ${channelInfo}` : '',
            toolsProfile: '',
            memory: '',
          }, null, null);
        }

        // Create authority links from subagents.allowAgents
        for (const agentDef of agents) {
          const allowAgents = agentDef.subagents?.allowAgents || [];
          const srcAgent = org.agents.find(a => a.id === agentDef.id);
          if (!srcAgent) continue;
          for (const subId of allowAgents) {
            const tgtAgent = org.agents.find(a => a.id === subId);
            if (tgtAgent) {
              connectAgents(srcAgent, tgtAgent, 'authority');
            }
          }
        }
      }

      // Auto-layout after import
      setTimeout(() => {
        document.getElementById('btn-auto-layout').click();
        renderGroupOverlays();
        updateOrgDisplay();
        scheduleSave();
        toast(`${org.agents.length}ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
      }, 100);
    }

    document.getElementById('btn-save').addEventListener('click', () => {
      clearTimeout(saveTimer);
      saveToStorage();
    });

    // --- New Organization ---
    document.getElementById('btn-new-org').addEventListener('click', () => {
      const name = prompt('çµ„ç¹”åã‚’å…¥åŠ›:');
      if (!name) return;
      editor.clear();
      org = {
        id: crypto.randomUUID(),
        name,
        description: '',
        version: 'v1',
        agents: [],
        links: [],
        groups: []
      };
      nodeToAgent = {};
      connectionTypes = {};
      closePanel();
      updateOrgDisplay();
      saveToStorage();
    });

    // --- Clear ---
    document.getElementById('btn-clear').addEventListener('click', () => {
      if (!confirm('å…¨ãƒãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      editor.clear();
      org.agents = [];
      org.links = [];
      org.groups = [];
      nodeToAgent = {};
      connectionTypes = {};
      closePanel();
      scheduleSave();
    });

    // --- Templates ---
    const templateModal = document.getElementById('template-modal');
    const templateOverlay = document.getElementById('template-overlay');

    function openTemplateModal() {
      templateModal.style.display = 'block';
      templateOverlay.style.display = 'block';
    }
    function closeTemplateModal() {
      templateModal.style.display = 'none';
      templateOverlay.style.display = 'none';
    }

    document.getElementById('btn-templates').addEventListener('click', openTemplateModal);
    document.getElementById('template-modal-close').addEventListener('click', closeTemplateModal);
    templateOverlay.addEventListener('click', closeTemplateModal);

    function applyTemplate(name) {
      if (org.agents.length > 0 && !confirm('ç¾åœ¨ã®çµ„ç¹”ã‚’ç½®æ›ã—ã¾ã™ã‹ï¼Ÿãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é©ç”¨ã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) return;

      editor.clear();
      org.agents = [];
      org.links = [];
      org.groups = [];
      nodeToAgent = {};
      connectionTypes = {};
      closePanel();

      if (name === 'startup') {
        org.name = 'ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒãƒ¼ãƒ ';
        const ceo = addAgent({ name: 'CEO', role: 'Chief Executive', icon: 'ğŸ‘‘', model: MODELS[0], personality: 'Vision and strategy. Final decisions.' }, 350, 60);
        const pm = addAgent({ name: 'PM', role: 'Project Manager', icon: 'ğŸ‘”', model: MODELS[0], personality: 'Sprint planning, progress tracking, task delegation.' }, 350, 240);
        const dev1 = addAgent({ name: 'Dev-1', role: 'Developer', icon: 'âš™ï¸', model: MODELS[1], personality: 'Frontend/backend implementation. Ships fast.' }, 180, 420);
        const dev2 = addAgent({ name: 'Dev-2', role: 'Developer', icon: 'ğŸ”§', model: MODELS[1], personality: 'Infrastructure, testing, deployment.' }, 520, 420);
        connectAgents(ceo, pm, 'authority');
        connectAgents(pm, dev1, 'authority');
        connectAgents(pm, dev2, 'authority');
        connectAgents(dev1, dev2, 'communication');
      } else if (name === 'hierarchy') {
        org.name = 'éšå±¤å‹çµ„ç¹”';
        const dir = addAgent({ name: 'Director', role: 'Director', icon: 'ğŸ¯', model: MODELS[0], personality: 'Strategic oversight. Cross-team coordination.' }, 400, 40);
        const mgr1 = addAgent({ name: 'Manager-A', role: 'Team Lead', icon: 'ğŸ‘”', model: MODELS[0], personality: 'Team A management. Sprint execution.' }, 200, 200);
        const mgr2 = addAgent({ name: 'Manager-B', role: 'Team Lead', icon: 'ğŸ‘”', model: MODELS[0], personality: 'Team B management. Quality assurance.' }, 600, 200);
        const m1 = addAgent({ name: 'Member-1', role: 'Developer', icon: 'âš™ï¸', model: MODELS[1], personality: 'Core feature development.' }, 100, 380);
        const m2 = addAgent({ name: 'Member-2', role: 'Developer', icon: 'ğŸ”§', model: MODELS[1], personality: 'API and integrations.' }, 300, 380);
        const m3 = addAgent({ name: 'Member-3', role: 'Designer', icon: 'ğŸ¨', model: MODELS[2], personality: 'UI/UX design and prototyping.' }, 500, 380);
        const m4 = addAgent({ name: 'Member-4', role: 'QA', icon: 'ğŸ§ª', model: MODELS[2], personality: 'Testing and quality assurance.' }, 700, 380);
        connectAgents(dir, mgr1, 'authority');
        connectAgents(dir, mgr2, 'authority');
        connectAgents(mgr1, m1, 'authority');
        connectAgents(mgr1, m2, 'authority');
        connectAgents(mgr2, m3, 'authority');
        connectAgents(mgr2, m4, 'authority');
        connectAgents(mgr1, mgr2, 'review');
      } else if (name === 'flat') {
        org.name = 'ãƒ•ãƒ©ãƒƒãƒˆãƒãƒ¼ãƒ ';
        const lead = addAgent({ name: 'Lead', role: 'Tech Lead', icon: 'â­', model: MODELS[0], personality: 'Coordination and technical guidance. First among equals.' }, 350, 80);
        const a = addAgent({ name: 'Agent-A', role: 'Generalist', icon: 'ğŸŸ¢', model: MODELS[1], personality: 'Flexible. Picks up whatever is needed.' }, 100, 280);
        const b = addAgent({ name: 'Agent-B', role: 'Generalist', icon: 'ğŸ”µ', model: MODELS[1], personality: 'Research-oriented. Explores solutions.' }, 350, 280);
        const c = addAgent({ name: 'Agent-C', role: 'Generalist', icon: 'ğŸŸ£', model: MODELS[2], personality: 'Detail-focused. Reviews and polishes.' }, 600, 280);
        connectAgents(lead, a, 'communication');
        connectAgents(lead, b, 'communication');
        connectAgents(lead, c, 'communication');
        connectAgents(a, b, 'communication');
        connectAgents(b, c, 'communication');
      }

      updateOrgDisplay();
      scheduleSave();
      closeTemplateModal();
      showToast(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${org.name}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`);
    }

    // connectAgents needs to be accessible from templates
    function connectAgents(srcAgent, tgtAgent, linkType) {
      const srcNodeId = Object.keys(nodeToAgent).find(k => nodeToAgent[k] === srcAgent.id);
      const tgtNodeId = Object.keys(nodeToAgent).find(k => nodeToAgent[k] === tgtAgent.id);
      if (!srcNodeId || !tgtNodeId) return;
      editor.addConnection(srcNodeId, tgtNodeId, 'output_1', 'input_1');
      const connKey = `${srcNodeId}_${tgtNodeId}`;
      const ct = connectionTypes[connKey];
      if (ct && linkType !== 'authority') {
        ct.type = linkType;
        const link = org.links.find(l => l.id === ct.linkId);
        if (link) link.type = linkType;
        applyConnectionColor(srcNodeId, tgtNodeId, linkType);
      }
    }

    document.querySelectorAll('.template-card').forEach(card => {
      card.addEventListener('click', () => applyTemplate(card.dataset.template));
      card.addEventListener('mouseenter', () => card.style.borderColor = '#3b82f6');
      card.addEventListener('mouseleave', () => card.style.borderColor = '#333');
    });

    // --- Init: load from storage or create demo ---
    function createDemoOrg() {
      org.name = 'AgentFlow Team';

      // Agents positioned for a clear hierarchy
      const ceo = addAgent({ name: 'ãƒŠãƒ„', role: 'CEO / Owner', icon: 'ğŸ‘‘', model: MODELS[0], personality: 'Final decision maker. Vision-driven.' }, 400, 60);
      const pm = addAgent({ name: 'é¬¼ç•œ', role: 'Project Manager', icon: 'ğŸ‘”', model: MODELS[0], personality: 'Strict progress tracking. 30-min report cycles.' }, 250, 240);
      const dev = addAgent({ name: 'nix', role: 'Developer', icon: 'âš™ï¸', model: MODELS[1], personality: 'Fast, pragmatic. Ships code.' }, 100, 420);
      const research = addAgent({ name: 'ã‚¢ãƒ©ã‚¤', role: 'Researcher', icon: 'ğŸ”¬', model: MODELS[2], personality: 'Data-driven analysis. Neutral perspective.' }, 400, 420);
      const critic = addAgent({ name: 'å€«ç†ã‚¢ãƒ³ãƒ', role: 'Strategy / Critic', icon: 'ğŸ”¥', model: MODELS[0], personality: 'Brutal honesty. Finds every flaw.' }, 600, 240);

      connectAgents(ceo, pm, 'authority');
      connectAgents(pm, dev, 'authority');
      connectAgents(pm, research, 'authority');
      connectAgents(ceo, critic, 'review');

      updateOrgDisplay();
      scheduleSave();
    }

    if (!loadFromStorage()) {
      createDemoOrg();
    }

    // --- Onboarding hints ---
    if (!localStorage.getItem('agentflow-hints-dismissed')) {
      document.getElementById('hints-overlay').style.display = 'flex';
    }
    document.getElementById('hints-close').addEventListener('click', () => {
      document.getElementById('hints-overlay').style.display = 'none';
      localStorage.setItem('agentflow-hints-dismissed', '1');
    });

  })();
  </script>
</Base>
